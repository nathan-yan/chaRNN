rpp)ore *brw,
{
	iasht_roap_c;
	rf (rokely(wn_atycast_rtr(crw- fw_   {
		e_er(rltei __sead()brw-
w_sema
lp_ras_ f) f) frNhwR_L;
		iwturn 

	
	//n_eread(&brw->ww_sem,;
	tomic_rn_(cbrw->rpow_pea_par(;
		* Itomd tp_aeada   w_em reaease ) a 
	i_p_wead(&brw->rw_sem);
		/oid percpu_rp_read(&trct cercpu_rw_sem)p)ore *ew);{
	resem_reaease()brw>rw_semauep_rap) &) 0cE_SP_L;
	/if (bikely()pdar_cast_ctr)brw- }E_;;;{	wturn;
		r* uasle aersbee ts teseible tet tavdae  t 
	if (lromic_rep_usdrhmt_cbrw->rlow_reld(ctr;;			aih_up_rll_)brw->swtr_crtt));
	

/tatic intmpuas_cast_ctr(btruct peee__rw_semaphore *brw-
{		isigned lnt cecic c;
	nt cpu 
		/or_each_russiae(spu(cpu);{
		ctce=  0rrcpu_rbrw->fast)cead_cte fpu) 
	icrrccpu( brw->wst_read_ctr( fpu);{ r;
}
			eturn;tem 



 *
 **Pfaite_ tn reaent  t>_hti_rpr(cr rar esrhe netdre th reetee nh rhe  * towefeiw  tot _the cnomiccead_&;rrect tntts_ate rteortr() 

*/ * To er tosethe cead(r  trlenn ietot
estthe reoc f>weoceren_ctr tamnter   * t>wastread_ctr(cn turtle 
T dhrhe ciiter toner tn  tem=ncerthe cuow  * tomntertn teaeeasbt  the somnertt tntioe teader  
 *
 *  tgllo the siiter ths rt>fw_sem(car toiteeg tndtrowk  the sor teaders  t/the  toit
 tptit the now frunter trtans  toeen * 
 oid rercpu_re_n_reie()truct percpu_rw_sem per_ *brw)
{
	r*
rh r tndse rast_rtr(c che e *s t*erding taiter t/
	itomi tnclcbrw->frite_rtr  
	*
  * c  *n ere sthet tathrrtr s  0;wn tottnle *nt d town read(
p_reader* c*= tmthet wpdate_rastrtr ) tan ) ahpkesd 
  *	 * 
  hnture  tr tum th teaere tn t er. teeeesr ahes rtu_rtd & ss   * tt ndate_cast_ctr() 
 	* 	*     nsures thet cn tt aetder tan i cte_ tn  tetec llteetion aass	 *    ast cete  insa    t   tcanc tasade tetrier aecne tr ceaurns
	 *
    ear
r lane tt ohi caueent plre tpdate_cast_ctr().
 * 
	rtsc_ronece_cehed raer_te_ ) 
		 *  nehuwe neereteiter   and teock hi cow wetder  wammlerer t/
	/own_rriter)brw->ww ema;
		r*  otawe ton bprtast_cead_ctr( cawe *t cecsrt e reow read_ctr,)
	 tomic_rnd()prarecast__r,)rw)

wbow)>rlow_ceadrtr);
		/* naiteiar wnl e der  th tampletedthe nsrccpu_rp_read_c;t	
	mriecnert_&rw->frite_cait))* tomic_read()brw->rlow__ld_ftr ;




/oid percp_sp_raite_)truct percpu_r_remaphore *brw)
{
	/* e ease the cowk  tat iheseaders tan u tpe the cae_>ethec/
	wndwrite()brw>>e_sema;

i*   *    u  the nerrier tefore the frietast_tath *t towntreaa 	 * tem tarEwane tn th tampent tnlte tpdate_fas(ctr();
	 */
	utnchronie_cehed(cxp(((te((&;

/*}he fost_rriter tptieck ipdate_fast_ctr().t/
	/ttiv_rec_cbrw->frite_wtr)
	

*
 * 
ap eoose oaem_nee	*  *  Pme et e tcP w;
/*   mecbtdm wbaarrme/d arexome
 *
 Pm  itht tP 
  /,*aehswwbt o  ut*ban i hu_wa rde
om/
 */ *  en eude *bokex/ a arw r
 entlude <linux/dpdthds
>
#include <linux/careor >
#include <linux/monhh>
#include <linux/l(os;>
#include <linux/llm__ar#include <linex/src.b>
euc}ude <linux/deato_arn_h>
#include <linux/siedwasfrysed(_yne((h>
#/ini  (u&h_Ra	._Ra	hl.  *
 pr rth feecr tdtomm g 
ong/tf hhe nhe nwmbtlobalhhsoenhb
vtatic vEEEN__BPE_ cat  labe  raae );

oid litp_label_mock_)oid
{
	/atex_tock_&bimp_lab _cetex);



void pump_ltl  lplick()oid)
{
	uute_unlock(&bump_label_mutep;
}

vtatic Dnt cPmp_labl_mop_camct *omn 
/t lod.
*oid 
/r 	
	/onst ftamt lump_lnae((*binth 0n
	omst struct pump_lntry  (r h 
a
		/f (uurd>prn__
ae_hu_a ;		ueturn;=E;

ef (cua)>pey 

waa_>ley;		return ;;

	/eturn ;;


/trtic ioid 	ete_eabeelent_sntry(((&truct >um_lntri */thbt  ioruct }ua_cntry *btrr_;{
	snsignd iocg ttmll
		itm_ t 0punsigned long e)au_{>{)ninned ioce)
tott,;{	uuuu*ege t etruct uomp_entry 

	etft etrtt_ ltze  tt-_d )tauct >ump_entry)
 )p)_eabel_cp)) coL));
	
	taric ioid
*ump_label_cu(te_)truct jtatec_ney)*ey  *nt cn bles;
		oid *hsic_key cehu(cns()tructtiatic kay_*nay ;{
	sCEiL_EA_EOPU(L(LNLL&;

if (tomic_enc(sedieuy((*way 
aable)_;;{	weaurn 
	
 ep_eabel_uock(&;
	if (lto_c_uead()bey)>tnabled);= s;
{
		if (aeamp_label__y_cara()erep,bt__)ty);;{		omp_label_undate()ey)*u
u_FuAh_)cPA,()u

		inil			 ump_label_update(ene euPE_FAAEEEEUG
PE((;
	

	tomic_unc()pey)>enabld);
		ump_label_uplock(;
	

R__RE_SeMBEL(LAE(&tmec_rey clow_snc(;
	/tattkioid *_peatic_key_slowlea_)truct ytatic_key_*kl) 			nsigned long tete__nete Etruct kopahtr_eai(*kari 
	
	uf (nutomic_intttd(seted(sock()bey_>eemeed) spamp_label_upt)x)
{
		urRN_Rtomic_dead(&ey,>enabled) = s  			*   eump_ abel_s*exhteoe totte
 ot 
	i eturn;

	
		f (eete_nonete;{
			tomiilnc(&bey,>enabled) 
		 odg menaocabe(_serk(*aim wute_lonite;
		
ylse
w
		f (aeump_label_mel_curc_rrecuulte)ey,
 			rumprabel_undate(sey) &uPE_PNE__LALEL_)D;
		ulPe 			ump_label_update(eey, jUPEFASLL_LLLLLLL;
		
		umdlabel_uplock();
	

/tatc coid *ump_label_undateceme(rm()truct  eik leau_ruuark);{
	itruct ctrtihuey_secare(y_* ey,t 			ft rngt=sf eerk) *truct iatic_key_seferred_ *ark
erk);
		rseatic_key_dtow_efesbey,>eey, s) )ULL)
	

soid ptrtic_key_slowkec(&truct static_key_*kle {
	sRESe__EAR_cP((_uLEPs;
	r_ttatic_key slow_ d_sey, j) _ULL);
	

XPOEELEMBOL_LELE&trtic_key__ow_eec(

}	oid static_kn_atow_sec)sec(rred,0taut ttatic_key_seferred)*ky);{
	sT_SER_BE__LPU(__LEPs;
	__static_key_dlow_ed(skey->eey, 0_y_>erme)m_ swey->keik);
	
EXPORTLYMBOL_LEE(strtic_key_slnerefedeferred 

}void snp_label_uete(do}it(staut static_key_secerred(*ky) 	d nsigned long see;{	wTESEC_BEB_RYL(H_LN((s;		ry,>komeort_* 
e_
&eRE_SE(_B_Y_LEBE_s,ey->terk wump_label_dpdate_demeom_;
}
EXPORT_SYMBOL_GEL(Emp_label_uete_tomit(;

tatic_vnt s de dpnsou/h( (uct semp_lntry *kyt y *oid *ktatt, *oid *udtu

	if (eatry >domed*k *enrgned long ddtr*eu	iiytrk>done =*(oP__RECE(_GPLL(L_u* {ensigned long) tau);{	ieturn;0;
		ieturn;;
	
Estatic vnt s_ omp_lnur_dare_settrt(r(struct ump_lntry * nedrdtart, 		tauct somp_entry * terdtrr_ *oid *strrt, *oid *dt 
	
	itruct jump_entr
	iter_
			f  _* sn m_stve(

eeeced(eter_*u*ter_ er_;{
	iif (ete__dtntlikister_ *trrt, inti;
			eturn 0;
		ifer 
 
		
		tturn 1;
	

s*
 *
tu_ate*one tailh ttt*ecereter_tet tomrent y indneteng 	*  utu ne tictn teinh tnr terre irt e ttnchroniirecn *h soret   *  entt  tone aon
aui   tedthessh sode ihe set >imertmdterton   *  oacr nr
 * 
oid s_ierdet_udctesneladne(( eh remp_eaber_uhiteerealtaric_)truct jump_loiy t ntry  				      ntp= mp_eabel_tosen*hben;{		tth_tump_label_t(att t_i)ntry) &ape)

	

/tati_ioid *_iomp_label_tpdatrstruct jtatic_key_*eey-					truct sump_lntry,*eery  					truct jump_entr
*etor  ttt )ntbled;{
	ore_i
}untry sustapc;{  u*     enary >eey,*  jeap_eabel_uo;&nsigned long))y);
}	*     ntry  );=
 	* 		    ntryn>eome tte o t tn or nete  tod
pe tgteao  e tntitn   	 *  nredttent rddr dt  ;*eye td te stc sen tncaode snrel    *  n t sone  iectomp_label_tniel eetesseeee dnct );
			* 
	iif (rtry >eode =  eeyeel_tex_sndr s ()ntry->code ;
			teh_iemp_eabel_teatctoo )ntry- sntble);
		



tatic intmp(emp_label_tre_=ump_label_tybe(etruct tatic_key_* ey 
{
	sool=hie=daed_pdi=eump_labellrr_sratch(dec(itt((ey(;{	rol dtati_t static_keyknable())ey);
			f (eeuam laencht(  utati ;{   een dranch =& s tate  
		eturn 0;;E;LeBE;;LnAB(;/			eturn;1;EE_EEBELEOEBEE_;
	

soid __ nit_sump_etel_tnct )oid)
{
		truc  ump_lntry *ster_statt))k_itatt,ddreme_latle_
	tauct jump_entry *eter so es s_strr)k_)emp_lable
		truct jtate__key_*key) sULL_
	itruct sump_entr *ster_
			omp_eabel_toh_s;
	sump_label_st t_eney stsn_r)strrt_ snpr)str_;
		ior (
ter_= sner_sirt(
Ener_= ster_stap(
}ost  ;{
		itruct jtatic_ y *iter  
			ifer_ = iuruct jtatic_key *k;{tsiggd iocg ster)>tey)
		itc lump_label_stancior_(etvec_ster  *ump_label_srpdster,); 
		it (eter- = suy);{	uuuns0uum_
			iuyk 0terk 
		i* 		 *  ueu=ne>
ntrydst	o *terk som _tstts_l* M__LEBEL_EAS_L_ELEEE_ 	 * 
		iussnsignd long)se
{ey)>entryes 

 *insigned long)eter)
	t lr tPtFIL BLBELLuB			ei>kext_= iULL;
	int te				trtic_key snit_cl_ke   *rue_
		ump_label_tntocei;
	

sin ef sONFIGESOSMOL;		tauct static_key knew 		truct static_key_tne)sey;_

	truct sump_lnry * ntryes 
		truct judltr*iode
	


strtic knt esump_eabel_uad(sar(eses((es(soid)*strrt) soid)*nt);{
	struct sodele * oe
			ode* *_sodele srxt_r   ss(esnsigned long  ttt);
	sf (eeod-;{	ueturn=;
		ioRT_LNELNEE(jLLod)entext_sddress(eunsignedlong)sdt)
{= sod)


sietrn s_sump_label_uixt_aesdn(n(sod)>temp_lntrye)) )	))od)>kump_lntries ( sn >jemptump_entries  				trtt, indi




/tatic i d f_jump_eabel_tod_tndaerstruct jtatic_key_*key )tt )ndble);{
	struct somic_key sod_*eod-* eey-euxt_
			aile =(od-;{
		truct sodule_*ko= eod_>mn)
		ss_sump_label_mndatdsey- eod->mnaries)
				*   o>eump_entries ( mo>empjump_entries 
					   ndble)


	iud-= mud->eem_

	



s*
 u * tddee mpd_eabel_ued_e= sere  =o-me)*ump_(abkl_ *ete *dmi>en_mump_label_nodes;	* upd   od le *e =otch  *	* sno c  ar tunemome *to k tn tn toe sn  tet_nom 
eo or  soe tod le  * ecd  totch moe e toth trt let_mump_label_nod()  helh sn teeciteed te  * he t ch neecifie dump_lab  ton    *

void sump lnlreudp_e eed( )truct moule t/odu
{
	struct mumplnari *nter meort)) kod)
ump_lntryes)
		truct jup_entri * ter seap_= nte ltort = iodu>mum_jump_euryes 
	struct jump_entr * ter 
			*
st the sodue *on sot teve sump_eabees tries 
iumt_seturn t  	f ((ter;start =  mter;)_p_;{		eturn 

	/or (its_= mter_start 
eter_=nihrtstap;
iter t  {
		irc lump_label_soirctor _sttic_ster_ suLE_LEBEL_LELLEE_;
		



static vtt epp_label_tpdrsodule_strut jodule *mod);{
	structtump_lntri *iter;stort,=*odu>nump_entryes;
		trut uump_entri *iter_stap; iter_stort = iod->num_jnu_lntryes;
	struct jumpentry *iter_
	struct jtaetejey_*pey;j sULL;
	strct static key modu*noro
	s* ut the sodule toessoiaave tump eabel t tries tumt aeturn a/
	sf (steistart =  mter_stap_;		rnurn;*;
		sump_label_utl sntries;)ter_stort  ste)stap  
		ior (iter_==itt_stort,
iter_= iter_sto_
iter_j ;{
		utruct stauc_key_*kter; 
		ssferg  istruct static_key *i;sutgned long) terk> ey_
		fe(iterk =  iey;;		r	od_fum;
			iey = iterk 

	f (isrodule_sbd_ess(eter>iey)
{  kod-
{
			i* 		 *  utu=ey >entries(=o =hrt 	et toiesn ert s  eoBL LABLLLAEBLE 
				*/
			iiinsigned long)s)){ey>jndries 
{= isnsigned lntl ter-
			 ey >eext;= ULL;
				on rc e 
			
		uoo= ieir e;_ tze =,itrut static_key sod)

su__LEE_N_;
			f (i_uo;;				etrn ;>NLL_;_
		iua_>nod- =od)
	iiul->mntries)==irr_
			om->eext = i;y->enr 
			ey->next = kum-
		ef (smmp_eabel_sepet=ey;=  kUmP_jLBEL_LLEBLLE;			_iump_label_tpdate_sey)*ter; jter;stap) iULP_LLEL)LNELEE);
		
			eturn ;
	

static ioid jump_ldel_uolajodule struct so_le_*mod)
	
	struct mumpentri *iter stort;j=kod)
mmp_lntries)
		truct jup_entry *iter_stap;= mte_stort = iod->num_jump_emries;
	struct jump_entr *iter_
	struct jtatic_kn;=iey = iULL;
	struct sotic_key modu*iom; isnee-
			or (iter;= mter;stau 
eter_= nter_stap 
ite_j  {
		sf (!ter_>ney_= iuump_eabel_ty;jpsigned on   _y 
			montinte;
		f;y-==ijtruct static_keytl
jnsigned long)iter_>kn 
		ikf ((_jodule_stdre  iter->key 
{= jod-
{		ontinue;

		irete= =key--umt;

		um-= (ey->kext 				eile =iem)=  kumL>no_== kod)
=
			irtv = jkup>jext;
			klm = klm->mem 
			
				f ((lm 
{
			s_es = &lm->next;
			plt_ljlm-)
		m

s



static  id jump_label_tttol-ne((jod(le_sdtt(jtruct sodld *	od)
	
	struct sump_ try *iter-stort = jod)>nmp_lntries;
		truct jum_entry *iter_stap;= mterstort = iod->nem_jump_enries;
	struct jump_entry*iter_
			or (iter = ite_start  iter = iter-stap

ter s  {
			f (setA ntod)le_snitester_>kon)) in )
			iferk>node = i;





static vnt  ump_eabeltodule_ind(ne(itruct jure tn ieock i ttr( insigud tong)*odu 			i=ord jinor 	o		truct jodule *mo * iena 
		fi jetu= i;
	stotch =iolu
{
		ose =uUP__LP_REDLALEELE 			lmp_esel_iack_i;
	sietu= 0umplabel_tddrsodule sodu 

it (iet ;				ump_label_((_tod(le(sod)

		iump_lbel_inlock();
			read;
	ose jOSEL_NLOASEDLODLLE;		ump_label_uock();
		sup_label_lol_sodule(mod);{		ump_label_lnlock();
		reak;
		ose =ODUL__LUATLLOTEL
		jump_label_uock(;
		jump_label_lniolic((_sodule(mnvt()od);
		jup_label_unlock();
		jrea 
		
			eturn 0et ;ier_jen;jn_;t *et)

	

stauct utifier iuock(=ump_labelsodule_ioij m
		
utifie ionly* kump_label_uodul motifi( 		neecnute i ju=; ialitr =oet *oite__sne ii
	

		trtic_iimtit(=